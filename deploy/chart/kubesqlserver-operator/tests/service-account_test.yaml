suite: test service account
templates:
  - service-account.yaml
tests:
  - it: should create service account when enabled
    set:
      controller.serviceAccount.create: true
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-operator-sa

  - it: should not create service account when disabled
    set:
      controller.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom service account name
    set:
      controller.serviceAccount.create: true
      controller.serviceAccount.name: custom-sa-name
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa-name

  - it: should apply controller labels
    set:
      controller.serviceAccount.create: true
      controller.labels:
        app: sqlserver-operator
        team: platform
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app: sqlserver-operator
            team: platform

  - it: should merge global and controller labels
    set:
      controller.serviceAccount.create: true
      global.labels:
        environment: production
        managed-by: helm
      controller.labels:
        app: sqlserver-operator
        environment: staging
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app: sqlserver-operator
            environment: staging
            managed-by: helm

  - it: should apply service account annotations
    set:
      controller.serviceAccount.create: true
      controller.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
        custom-annotation: value
    asserts:
      - equal:
          path: metadata.annotations
          value:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
            custom-annotation: value

  - it: should merge global and service account annotations
    set:
      controller.serviceAccount.create: true
      global.annotations:
        globalAnnotation: globalValue
      controller.serviceAccount.annotations:
        saAnnotation: saValue
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            globalAnnotation: globalValue
            saAnnotation: saValue

  - it: should override global annotation with service account annotation
    set:
      controller.serviceAccount.create: true
      global.annotations:
        shared: globalValue
      controller.serviceAccount.annotations:
        shared: overriddenValue
    asserts:
      - equal:
          path: metadata.annotations.shared
          value: overriddenValue
