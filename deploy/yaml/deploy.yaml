---
# Source: kubesqlserver-operator/crds/databases_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: databases.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: Database
    listKind: DatabaseList
    plural: databases
    singular: database
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the SQL Server database.
            properties:
              state:
                description: The current state of the database.
                type: string
              message:
                description: A message indicating the current status of the database.
                type: string
              lastChecked:
                description: The last time the database status was checked.
                format: date-time
                nullable: true
                type: string
            type: object
          spec:
            description: Spec of the SQL Server database.
            properties:
              instanceName:
                description: The name of the SQLServer or ExternalSQLServer instance where the database will be created.
                type: string
              databaseName:
                description: The name of the database to be created.
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/crds/externalsqlservers_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: externalsqlservers.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: ExternalSQLServer
    listKind: ExternalSQLServerList
    plural: externalsqlservers
    singular: externalsqlserver
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the external SQL Server connection.
            properties:
              state:
                description: The current state of the connection.
                type: string
              message:
                description: A message providing details on the current connection status.
                type: string
              lastChecked:
                description: The last time the connection was verified.
                format: date-time
                nullable: true
                type: string
              isConnected:
                description: Whether the connection to the external SQL Server is healthy.
                type: boolean
            type: object
          spec:
            description: Spec of the external SQL Server connection.
            properties:
              host:
                description: The hostname or IP address of the SQL Server instance (e.g., myserver.database.windows.net, 10.0.0.5, mydatabase.rds.amazonaws.com).
                type: string
              port:
                description: The port number for the SQL Server connection.
                format: int32
                type: integer
              secretName:
                description: The name of the Kubernetes secret containing SQL Server credentials (must contain 'password' keys).
                type: string
              useEncryption:
                description: Whether to use SSL/TLS encryption for the connection.
                type: boolean
              trustServerCertificate:
                description: Whether to trust the server certificate (set to true for self-signed certificates).
                type: boolean
              additionalConnectionProperties:
                additionalProperties:
                  type: string
                description: Optional connection string parameters as key-value pairs (e.g., for Azure AD authentication, connection timeout, etc.).
                nullable: true
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/crds/sqlserverlogins_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sqlserverlogins.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: SQLServerLogin
    listKind: SQLServerLoginList
    plural: sqlserverlogins
    singular: sqlserverlogin
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the SQL Server login.
            properties:
              state:
                description: The current state of the SQL Server login.
                type: string
              message:
                description: A message indicating the current status of the SQL Server login.
                type: string
              lastChecked:
                description: The last time the login status was checked.
                format: date-time
                nullable: true
                type: string
            type: object
          spec:
            description: Spec of the SQL Server login.
            properties:
              sqlServerName:
                description: The name of the SQLServer or ExternalSQLServer instance.
                type: string
              loginName:
                description: The login name for authentication.
                type: string
              authenticationType:
                description: The authentication type for the login (e.g., SQL, Windows).
                type: string
              secretName:
                description: The name of the Kubernetes secret storing authentication credentials.
                nullable: true
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/crds/sqlservers_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sqlservers.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: SQLServer
    listKind: SQLServerList
    plural: sqlservers
    singular: sqlserver
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the SQL Server deployment.
            properties:
              state:
                description: The current state of the SQL Server deployment.
                type: string
              message:
                description: A message providing details on the current status of SQL Server.
                type: string
            type: object
          spec:
            description: Spec of the SQL Server deployment.
            properties:
              image:
                description: The container image to use for SQL Server.
                type: string
              storageClass:
                description: The name of the storage class to use for SQL Server storage.
                type: string
              storageSize:
                description: The size of the persistent storage volume.
                type: string
              secretName:
                description: The name of the Kubernetes secret containing SQL Server credentials.
                nullable: true
                type: string
              serviceType:
                description: The type of Kubernetes service to expose SQL Server (e.g., ClusterIP, NodePort, LoadBalancer).
                nullable: true
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/crds/sqlserverschemas_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sqlserverschemas.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: SQLServerSchema
    listKind: SQLServerSchemaList
    plural: sqlserverschemas
    singular: sqlserverschema
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the SQL Server database schema.
            properties:
              state:
                description: The current state of the schema.
                type: string
              message:
                description: A message indicating the current status of the schema.
                type: string
              lastChecked:
                description: The last time the schema status was checked.
                format: date-time
                nullable: true
                type: string
            type: object
          spec:
            description: Spec of the SQL Server database schema.
            properties:
              instanceName:
                description: The name of the SQLServer or ExternalSQLServer instance where the schema will be created.
                type: string
              databaseName:
                description: The name of the database to create the schema in.
                type: string
              schemaName:
                description: The name of the schema to be created.
                type: string
              schemaOwner:
                description: The database user that owns this schema.
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/crds/sqlserverusers_sql-server_dotkube_io.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sqlserverusers.sql-server.dotkube.io
spec:
  group: sql-server.dotkube.io
  names:
    kind: SQLServerUser
    listKind: SQLServerUserList
    plural: sqlserverusers
    singular: sqlserveruser
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          status:
            description: Status of the database user.
            properties:
              state:
                description: The current state of the database user.
                type: string
              message:
                description: A message indicating the current status of the database user.
                type: string
              lastChecked:
                description: The last time the database user status was checked.
                format: date-time
                nullable: true
                type: string
            type: object
          spec:
            description: Spec of the database user.
            properties:
              sqlServerName:
                description: The name of the SQLServer or ExternalSQLServer instance.
                type: string
              databaseName:
                description: The name of the database where this user will be created.
                type: string
              loginName:
                description: The login name for the database user.
                type: string
              roles:
                description: The roles assigned to the database user.
                items:
                  type: string
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
# Source: kubesqlserver-operator/templates/service-account.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sql-server-operator-sa
  labels:
    
    app: "sqlserver-operator"
    app.openshift.io/runtime: "dotnet"
---
# Source: kubesqlserver-operator/templates/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: sql-server-operator-role
rules:
# Custom Resource Definitions - full access to our CRDs
- apiGroups:
  - sql-server.dotkube.io
  resources:
  - sqlservers
  - externalsqlservers
  - databases
  - sqlserverlogins
  - sqlserverusers
  - sqlserverschemas
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch

# Custom Resource Status subresources
- apiGroups:
  - sql-server.dotkube.io
  resources:
  - sqlservers/status
  - externalsqlservers/status
  - databases/status
  - sqlserverlogins/status
  - sqlserverusers/status
  - sqlserverschemas/status
  verbs:
  - get
  - patch
  - update

# Secrets - needed to read SA passwords and manage secrets
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - create
  - get
  - list
  - watch

# ConfigMaps - needed to create SQL Server configuration
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - get
  - list
  - watch

# Services - needed to create SQL Server services
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - create
  - get
  - list
  - patch
  - update
  - watch

# Events - needed to emit Kubernetes events
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
  - update

# StatefulSets - needed to create SQL Server statefulsets
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - create
  - get
  - list
  - watch

# Leases - needed for leader election
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
  - get
  - list
  - update
  - watch

# CustomResourceDefinitions - needed for CRD installer to check/install CRDs
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - get
  - list
  - create
  - update
  - patch
  - watch
---
# Source: kubesqlserver-operator/templates/role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sql-server-operator-rb
  labels:
    
    app: "sqlserver-operator"
    app.openshift.io/runtime: "dotnet"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sql-server-operator-role
subjects:
  - kind: ServiceAccount
    name: sql-server-operator-sa
    namespace: sql-server
---
# Source: kubesqlserver-operator/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sql-server-operator
  labels:
    
    app: "sqlserver-operator"
    app.openshift.io/runtime: "dotnet"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sqlserver-operator
      app.openshift.io/runtime: dotnet
  template:
    metadata:
      labels:
        app: sqlserver-operator
        app.openshift.io/runtime: dotnet
        
        app.openshift.io/runtime: "dotnet"
    spec:
      serviceAccountName: sql-server-operator-sa
      containers:
        - name: operator
          image: ghcr.io/dotkube/kubesqlserver-operator/kubesql-controller:2025-12-07
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
          resources:
            {}
